//graph schema is on page 19 https://ldbc.github.io/ldbc_snb_docs/ldbc-snb-specification.pdf
//BI 7 query description is on page 95 https://ldbc.github.io/ldbc_snb_docs/ldbc-snb-specification.pdf
CREATE OR REPLACE DISTRIBUTED QUERY bi7(STRING tag) SYNTAX v3 {

  # count is a reserved keyword.
  TYPEDEF TUPLE <STRING relatedTagName, UINT replyCount> RESULT;

  HeapAccum<RESULT>(100, replyCount DESC, relatedTagName ASC) @@result;

  SumAccum<UINT> @count;

  tagWithName = SELECT t FROM (t:Tag {name:tag});
  replies = SELECT c FROM (:tagWithName) <-[:HAS_TAG]-()<-[:REPLY_OF]- (c:Comment);
  repliesWithTag = SELECT r FROM (:tagWithName) <-[:HAS_TAG]- (r:replies);
  repliesWithoutTag = replies MINUS repliesWithTag;

  tmp =
    SELECT t
    FROM  (r:repliesWithoutTag) -[:HAS_TAG]-> (t:Tag)
    ACCUM t.@count += 1
    POST-ACCUM (t) @@result += RESULT(t.name, t.@count);

  PRINT @@result as result;
}
